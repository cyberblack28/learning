<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>12.Kubernetes</title>

  <!-- Bootstrap -->
  <link href="../css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/custom.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
  <header id="header">
    <header-title></header-title>
  </header>

  <hr>

  <div class="contents_area">
    <h2>12.Kubernetes</h2>

    <h3>Kubernetesの構築テキスト</h3>

    <h4 class="h4_title">事前作業</h4>

    <ol>
      <li>studentユーザでログインして、rootユーザに変更します。
        <!-- code -->
        <pre class="pre"><code>$ su -
パスワード:tokyoec
#
</code></pre>
        <!-- /code/ -->
      </li>
    </ol>

    <h4 class="h4_title">kindのインストール</h4>

    <ol>
      <li>kindのダウンロード
        <!-- code -->
        <pre class="pre"><code># curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64
        % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
        Dload  Upload   Total   Spent    Left  Speed
100    97  100    97    0     0    130      0 --:--:-- --:--:-- --:--:--   130
100   642  100   642    0     0    584      0  0:00:01  0:00:01 --:--:--  2268
100 7247k  100 7247k    0     0  1664k      0  0:00:04  0:00:04 --:--:-- 2883k</code></pre>
        <!-- /code/ -->
      </li>
      <li>実行権限の付与
        <!-- code -->
        <pre class="pre"><code># chmod +x ./kind</code></pre>
        <!-- /code/ -->
      </li>
      <li>実行場所にkindを移動
        <!-- code -->
        <pre class="pre"><code># mv ./kind /usr/local/bin</code></pre>
        <!-- /code/ -->
      </li>
      <li>kindコマンドの実行
        <!-- code -->
        <pre class="pre"><code># kind version
kind v0.9.0 go1.15.2 linux/amd64</code></pre>
        <!-- /code/ -->
      </li>
    </ol>

    <h4 class="h4_title">kindでKubernetesクラスタの構築</h4>

    <ol>
      <li>「multinode.yaml」の作成
        <!-- code -->
        <pre class="pre"><code># vim multinode.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
# 1 control plane node and 3 workers
nodes:
# the control plane node config
- role: control-plane
# the three workers
- role: worker
- role: worker
- role: worker
</code></pre>
        <!-- /code/ -->
      </li>
      <li>Kubernetesクラスタの構築
        <!-- code -->
        <pre class="pre"><code># kind create cluster --name k8s --config multinode.yaml
Creating cluster "k8s" ...
 ? Ensuring node image (kindest/node:v1.19.1) ?
 ? Preparing nodes ? ?Ζ ? ?Ζ
 ? Writing configuration ?
 ? 袴tarting control-plane ?刻?
?? 孤nstalling CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
?? Installing CNI ?
 ? Installing CNI ?

 ? 症nstalling StorageClass ?
 ? Joining worker nodes ?
Set kubectl context to "kind-k8s"
You can now use your cluster with:

kubectl cluster-info --context kind-k8s

Thanks for using kind! ?</code></pre>
        <!-- /code/ -->
      </li>
    </ol>

    <h4 class="h4_title">kubectlコマンドのインストール</h4>

    <ol>
      <li>kubectlコマンドのダウンロード
        <!-- code -->
        <pre class="pre"><code># curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
        % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
        Dload  Upload   Total   Spent    Left  Speed
100 38.3M  100 38.3M    0     0  9770k      0  0:00:04  0:00:04 --:--:-- 9770k
</code></pre>
        <!-- /code/ -->
      </li>
      <li>実行権限の付与
        <!-- code -->
        <pre class="pre"><code># chmod +x ./kubectl</code></pre>
        <!-- /code/ -->
      </li>
      <li>実行場所にkubectlを移動
        <!-- code -->
        <pre class="pre"><code># mv ./kubectl /usr/local/bin</code></pre>
        <!-- /code/ -->
      </li>
      <li>kubectlコマンドの実行
        <!-- code -->
        <pre
          class="pre"><code># kubectl version --client
Client Version: version.Info{Major:"1", Minor:"20", GitVersion:"v1.20.1", GitCommit:"c4d752765b3bbac2237bf87cf0b1c2e307844666", GitTreeState:"clean", BuildDate:"2020-12-18T12:09:25Z", GoVersion:"go1.15.5", Compiler:"gc", Platform:"linux/amd64"}</code></pre>
        <!-- /code/ -->
      </li>
      <li>kubectl get nodes
        <!-- code -->
        <pre class="pre"><code># kubectl get nodes
        NAME                STATUS   ROLES    AGE    VERSION
        k8s-control-plane   Ready    master   142m   v1.19.1
        k8s-worker          Ready    <none>   141m   v1.19.1
        k8s-worker2         Ready    <none>   141m   v1.19.1
        k8s-worker3         Ready    <none>   141m   v1.19.1
</code></pre>
        <!-- /code/ -->
      </li>
    </ol>

    <h4 class="h4_title">kubectlコマンド演習</h4>

    <h5 class="h5_title">Pod作成</h5>

    <ol>
      <li>Nginxという名前のNginx Podを作成
        <!-- code -->
        <pre class="pre"><code># kubectl run nginx --image=nginx --restart=Never
pod/nginx created
</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginx Podの確認
        <!-- code -->
        <pre class="pre"><code># kubectl get pod
NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          2m17s</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginx PodのClusterIP確認
        <!-- code -->
        <pre class="pre"><code># kubectl describe pod nginx | grep IP:
IP:           10.244.3.2
  IP:  10.244.3.2</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginx Podのアクセス確認
        <!-- code -->
        <pre class="pre"><code># kubectl run busybox --image=busybox --restart=Never -it --rm -- sh
If you don't see a command prompt, try pressing enter.
/ #
# wget -O- 10.244.3.2
Connecting to 10.244.3.2 (10.244.3.2:80)
writing to stdout
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
-                    100% |*************************************************************************************************************|   612  0:00:00 ETA
written to stdout
/ # exit
pod "busybox" deleted
</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginx Podの削除
        <!-- code -->
        <pre class="pre"><code># kubectl delete pod nginx
pod "nginx" deleted</code></pre>
        <!-- /code/ -->
      </li>
      <li>削除されたことを確認
        <!-- code -->
        <pre class="pre"><code># kubectl get pod
No resources found in default namespace.</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginx Podをyamlを生成して、そのyamlから作成
        <!-- code -->
        <pre
          class="pre"><code># kubectl run nginx --image=nginx --restart=Never --dry-run=client -o yaml > nginx.yaml</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># cat nginx.yaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: nginx
  name: nginx
spec:
  containers:
  - image: nginx
    name: nginx
    resources: {}
  dnsPolicy: ClusterFirst
  restartPolicy: Never
status: {}</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl create -f nginx.yaml
pod/nginx created</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl get pod nginx
NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          45s</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginx Podの詳細確認
        <!-- code -->
        <pre class="pre"><code># kubectl describe pod nginx
Name:         nginx
Namespace:    default
Priority:     0
Node:         k8s-worker2/172.18.0.2
Start Time:   Tue, 22 Dec 2020 21:33:04 -0500
Labels:       run=nginx
Annotations:  &lt;none&gt;
Status:       Running
IP:           10.244.2.4
IPs:
  IP:  10.244.2.4
Containers:
  nginx:
    Container ID:   containerd://4f241c50e7082668087ef8d568773fe8db5a04d000323523340a5f1d8792977e
    Image:          nginx
    Image ID:       docker.io/library/nginx@sha256:4cf620a5c81390ee209398ecc18e5fb9dd0f5155cd82adcbae532fec94006fb9
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Running
      Started:      Tue, 22 Dec 2020 21:33:07 -0500
    Ready:          True
    Restart Count:  0
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-w6w42 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  default-token-w6w42:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-w6w42
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  2m27s  default-scheduler  Successfully assigned default/nginx to k8s-worker2
  Normal  Pulling    2m26s  kubelet            Pulling image "nginx"
  Normal  Pulled     2m24s  kubelet            Successfully pulled image "nginx" in 1.899103542s
  Normal  Created    2m24s  kubelet            Created container nginx
  Normal  Started    2m24s  kubelet            Started container nginx</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginx Podの削除
        <!-- code -->
        <pre class="pre"><code># kubectl delete pod nginx
pod "nginx" deleted</code></pre>
        <!-- /code/ -->
      </li>
      <li>削除されたことを確認
        <!-- code -->
        <pre class="pre"><code># kubectl get pod
No resources found in default namespace.</code></pre>
        <!-- /code/ -->
      </li>
    </ol>

    <h5 class="h5_title">Label作成</h5>

    <ol>
      <li>nginxという名前でapp=v1というラベルを持つNginx Podを作成
        <!-- code -->
        <pre class="pre"><code># kubectl run nginx --image=nginx --restart=Never --labels=app=v1
pod/nginx created
</code></pre>
        <!-- /code/ -->
      </li>
      <li>すべてのPodラベル確認
        <!-- code -->
        <pre class="pre"><code># kubectl get pod --show-labels
NAME    READY   STATUS    RESTARTS   AGE   LABELS
nginx   1/1     Running   0          49s   app=v1
</code></pre>
        <!-- /code/ -->
      </li>
      <li>app=v2にラベル名を変更
        <!-- code -->
        <pre class="pre"><code># kubectl get pod --show-labels
pod/nginx labeled</code></pre>
        <!-- /code/ -->
      </li>
      <li>appラベルを持つPodのみ確認
        <!-- code -->
        <pre class="pre"><code># kubectl get pod -L app
NAME    READY   STATUS    RESTARTS   AGE   APP
nginx   1/1     Running   0          11m   v2</code></pre>
        <!-- /code/ -->
      </li>
      <li>app=v2ラベルを持つPodのみ確認
        <!-- code -->
        <pre class="pre"><code># kubectl get pod -l app=v2
NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          11m</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginx Podの削除
        <!-- code -->
        <pre class="pre"><code># kubectl delete pod nginx
pod "nginx" deleted</code></pre>
        <!-- /code/ -->
      </li>
      <li>削除されたことを確認
        <!-- code -->
        <pre class="pre"><code># kubectl get pod
No resources found in default namespace.</code></pre>
        <!-- /code/ -->
      </li>
    </ol>

    <h5 class="h5_title">Deployment作成</h5>

    <ol>
      <li>nginxという名前でバージョン1.19.1のNginx,レプリカ数2のDeploymentの作成
        <!-- code -->
        <pre
          class="pre"><code># kubectl create deployment nginx  --image=nginx:1.19.1 --dry-run=client -o yaml > nginx_dep.yaml</code></pre>
        <!-- /code/ -->
        nginx_dep.yamlのreplicasを1から2へ変更
        <!-- code -->
        <pre
          class="pre"><code># vim nginx_dep.yaml
--------------------------------------------------以下の内容をコピー&ペースト-----------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: nginx
  name: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx:1.19.1
        name: nginx
        resources: {}
status: {}
--------------------------------------------------[Esc + :wq]で保存終了します。--------------------------------------------------</code></pre>
        <!-- /code/ -->
        nginx_dep.yamlからDeploymentを作成
        <!-- code -->
        <pre class="pre"><code># kubectl create -f nginx_dep.yaml
deployment.apps/nginx created</code></pre>
        <!-- /code/ -->
      </li>
      <li>Podが2個生成されていることを確認
        <!-- code -->
        <pre class="pre"><code># kubectl create -f nginx_dep.yaml
deployment.apps/nginx created</code></pre>
        <!-- /code/ -->
      </li>
      <li>1podを削除して、セルフヒーリングを確認
        <!-- code -->
        <pre class="pre"><code># kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
nginx-69576c95db-hlm9l   1/1     Running   0          4m46s
nginx-69576c95db-zrhhc   1/1     Running   0          4m46s</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl delete pod nginx-69576c95db-hlm9l
NAME                     READY   STATUS    RESTARTS   AGE
nginx-69576c95db-hlm9l   1/1     Running   0          4m46s
nginx-69576c95db-zrhhc   1/1     Running   0          4m46s</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl delete pod nginx-69576c95db-hlm9l
pod "nginx-69576c95db-hlm9l" deleted</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
nginx-69576c95db-ch8pp   1/1     Running   0          44s
nginx-69576c95db-zrhhc   1/1     Running   0          6m41s</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginxを1.19.2にアップデート
        <!-- code -->
        <pre class="pre"><code># kubectl set image deployment nginx nginx=nginx:1.19.2
deployment.apps/nginx image updated</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl describe deployment nginx
Name:                   nginx
Namespace:              default
CreationTimestamp:      Tue, 22 Dec 2020 23:55:01 -0500
Labels:                 app=nginx
Annotations:            deployment.kubernetes.io/revision: 2
Selector:               app=nginx
Replicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=nginx
  Containers:
   nginx:
    Image:        nginx:1.19.2
    Port:         &lt;none&gt;
    Host Port:    &lt;none&gt;
    Environment:  &lt;none&gt;
    Mounts:       &lt;none&gt;
  Volumes:        &lt;none&gt;
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  &lt;none&gt;
NewReplicaSet:   nginx-c7598c4c (2/2 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  8m37s  deployment-controller  Scaled up replica set nginx-69576c95db to 2
  Normal  ScalingReplicaSet  49s    deployment-controller  Scaled up replica set nginx-c7598c4c to 1
  Normal  ScalingReplicaSet  33s    deployment-controller  Scaled down replica set nginx-69576c95db to 1
  Normal  ScalingReplicaSet  33s    deployment-controller  Scaled up replica set nginx-c7598c4c to 2
  Normal  ScalingReplicaSet  15s    deployment-controller  Scaled down replica set nginx-69576c95db to 0</code></pre>
        <!-- /code/ -->
      </li>
      <li>Revision内容の確認
        <!-- code -->
        <pre class="pre"><code># kubectl rollout history deployment nginx
deployment.apps/nginx
REVISION  CHANGE-CAUSE
1         &lt;none&gt;
2         &lt;none&gt;</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl rollout history deployment nginx --revision=1
deployment.apps/nginx with revision #1
Pod Template:
  Labels:       app=nginx
        pod-template-hash=69576c95db
  Containers:
   nginx:
    Image:      nginx:1.19.1
    Port:       &lt;none&gt;
    Host Port:  &lt;none&gt;
    Environment:        &lt;none&gt;
    Mounts:     &lt;none&gt;
  Volumes:      &lt;none&gt;</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl rollout history deployment nginx --revision=2
deployment.apps/nginx with revision #2
Pod Template:
  Labels:       app=nginx
        pod-template-hash=c7598c4c
  Containers:
   nginx:
    Image:      nginx:1.19.2
    Port:       &lt;none&gt;
    Host Port:  &lt;none&gt;
    Environment:        &lt;none&gt;
    Mounts:     &lt;none&gt;
  Volumes:      &lt;none&gt;</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginxのバージョンを1.19.1にロールバック
        <!-- code -->
        <pre class="pre"><code># kubectl rollout undo deployment nginx
deployment.apps/nginx rolled back</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre
          class="pre"><code># kubectl describe deployment nginx
Name:                   nginx
Namespace:              default
CreationTimestamp:      Tue, 22 Dec 2020 23:55:01 -0500
Labels:                 app=nginx
Annotations:            deployment.kubernetes.io/revision: 3
Selector:               app=nginx
Replicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=nginx
  Containers:
   nginx:
    Image:        nginx:1.19.1
    Port:         &lt;none&gt;
    Host Port:    &lt;none&gt;
    Environment:  &lt;none&gt;
    Mounts:       &lt;none&gt;
  Volumes:        &lt;none&gt;
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  &lt;none&gt;
NewReplicaSet:   nginx-69576c95db (2/2 replicas created)
Events:
  Type    Reason             Age                From                   Message
  ----    ------             ----               ----                   -------
  Normal  ScalingReplicaSet  28m                deployment-controller  Scaled up replica set nginx-c7598c4c to 1
  Normal  ScalingReplicaSet  28m                deployment-controller  Scaled down replica set nginx-69576c95db to 1
  Normal  ScalingReplicaSet  28m                deployment-controller  Scaled up replica set nginx-c7598c4c to 2
  Normal  ScalingReplicaSet  28m                deployment-controller  Scaled down replica set nginx-69576c95db to 0
  Normal  ScalingReplicaSet  47s                deployment-controller  Scaled up replica set nginx-69576c95db to 1
  Normal  ScalingReplicaSet  46s (x2 over 36m)  deployment-controller  Scaled up replica set nginx-69576c95db to 2
  Normal  ScalingReplicaSet  46s                deployment-controller  Scaled down replica set nginx-c7598c4c to 1
  Normal  ScalingReplicaSet  45s                deployment-controller  Scaled down replica set nginx-c7598c4c to 0</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginxのバージョンを revision 2 の nginx 1.19.2 にロールバック
        <!-- code -->
        <pre class="pre"><code># kubectl rollout undo deployment nginx --to-revision=2
deployment.apps/nginx rolled back</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre
          class="pre"><code># kubectl describe deployment nginx
Name:                   nginx
Namespace:              default
CreationTimestamp:      Tue, 22 Dec 2020 23:55:01 -0500
Labels:                 app=nginx
Annotations:            deployment.kubernetes.io/revision: 4
Selector:               app=nginx
Replicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=nginx
  Containers:
   nginx:
    Image:        nginx:1.19.2
    Port:         &lt;none&gt;
    Host Port:    &lt;none&gt;
    Environment:  &lt;none&gt;
    Mounts:       &lt;none&gt;
  Volumes:        &lt;none&gt;
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  &lt;none&gt;
NewReplicaSet:   nginx-c7598c4c (2/2 replicas created)
Events:
  Type    Reason             Age                  From                   Message
  ----    ------             ----                 ----                   -------
  Normal  ScalingReplicaSet  3m54s                deployment-controller  Scaled up replica set nginx-69576c95db to 1
  Normal  ScalingReplicaSet  3m53s (x2 over 39m)  deployment-controller  Scaled up replica set nginx-69576c95db to 2
  Normal  ScalingReplicaSet  3m53s                deployment-controller  Scaled down replica set nginx-c7598c4c to 1
  Normal  ScalingReplicaSet  3m52s                deployment-controller  Scaled down replica set nginx-c7598c4c to 0
  Normal  ScalingReplicaSet  42s (x2 over 31m)    deployment-controller  Scaled up replica set nginx-c7598c4c to 1
  Normal  ScalingReplicaSet  40s (x2 over 31m)    deployment-controller  Scaled down replica set nginx-69576c95db to 1
  Normal  ScalingReplicaSet  40s (x2 over 31m)    deployment-controller  Scaled up replica set nginx-c7598c4c to 2
  Normal  ScalingReplicaSet  38s (x2 over 31m)    deployment-controller  Scaled down replica set nginx-69576c95db to 0</code></pre>
        <!-- /code/ -->
      </li>
      <li>deploymentの削除
        <!-- code -->
        <pre class="pre"><code># kubectl delete deployment nginx
deployment.apps "nginx" deleted</code></pre>
        <!-- /code/ -->
      </li>
      <li>deployment削除の確認
        <!-- code -->
        <pre class="pre"><code># kubectl get deployment
No resources found in default namespace.</code></pre>
        <!-- /code/ -->
      </li>
    </ol>

    <h5 class="h5_title">Service作成</h5>

    <ol>
      <li>nginxという名前のポッドを作成、ポート80を公開
        <!-- code -->
        <pre class="pre"><code># kubectl run nginx --image=nginx --restart=Never --labels=app=v1
service/nginx created
pod/nginx created</code></pre>
        <!-- /code/ -->
      </li>
      <li>nginx serviceとエンドポイントのIP確認
        <!-- code -->
        <pre class="pre"><code># kubectl get service nginx
NAME    TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE
nginx   ClusterIP   10.96.18.42   &lt;none&gt;        80/TCP    90s</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl get ep
NAME         ENDPOINTS         AGE
kubernetes   172.18.0.3:6443   3h46m
nginx        10.244.3.7:80     2m33s</code></pre>
        <!-- /code/ -->
      </li>
      <li>busybox podを作成し、busyboxコンテナーからwgetコマンドでnginx serviceを経由したアクセス確認
        <!-- code -->
        <pre class="pre"><code># kubectl run busybox --image=busybox --restart=Never --rm -it /bin/sh
If you don't see a command prompt, try pressing enter.
/ #　wget -O- 10.96.18.42
Connecting to 10.96.18.42 (10.96.18.42:80)
writing to stdout
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
-                    100% |*************************************************************************************************************|   612  0:00:00 ETA
written to stdout
/ #　exit</code></pre>
        <!-- /code/ -->
      </li>
      <li>nginx podとnginx serviceの削除
        <!-- code -->
        <pre class="pre"><code># kubectl delete pod nginx
pod "nginx" deleted</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl delete service nginx
service "nginx" deleted</code></pre>
        <!-- /code/ -->
      </li>
    </ol>

    <h5 class="h5_title">configmap作成</h5>

    <ol>
      <li>“var1=docker” “var2=kuberntes”のconfigMap ‘config'を作成
        <!-- code -->
        <pre class="pre"><code># kubectl create configmap config --from-literal=var1=docker --from-literal=var2=kubernetes
configmap/config created</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl get configmap config
NAME     DATA   AGE
config   2      50s</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl get configmap config -o yaml
apiVersion: v1
data:
  var1: docker
  var2: kubernetes
kind: ConfigMap
metadata:
  creationTimestamp: "2020-12-23T06:23:54Z"
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:data:
        .: {}
        f:var1: {}
        f:var2: {}
    manager: kubectl-create
    operation: Update
    time: "2020-12-23T06:23:54Z"
  name: config
  namespace: default
  resourceVersion: "45693"
  selfLink: /api/v1/namespaces/default/configmaps/config
  uid: 27ec0744-4be0-4e9c-89bb-e71078fc9f9f</code></pre>
        <!-- /code/ -->
      </li>
      <li>configMap ’config’ をenv変数としてnginx podにロード
        <!-- code -->
        <pre
          class="pre"><code># kubectl run --restart=Never nginx --image=nginx -o yaml --dry-run=client > nginx_configmap.yaml</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre
          class="pre"><code># vim nginx_configmap.yaml
--------------------------------------------------以下の内容をコピー&ペースト-----------------------------------------------------
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: nginx
  name: nginx
spec:
  containers:
  - image: nginx
    imagePullPolicy: IfNotPresent
    name: nginx
    resources: {}
    envFrom:
    - configMapRef:
        name: config
  dnsPolicy: ClusterFirst
  restartPolicy: Never
status: {}
--------------------------------------------------[Esc + :wq]で保存終了します。--------------------------------------------------</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginx Podの作成
        <!-- code -->
        <pre class="pre"><code># kubectl create -f nginx_configmap.yaml
pod/nginx created</code></pre>
        <!-- /code/ -->
      </li>
      <li>環境変数が読み込まれていることを確認 ※var1=docker var2=kubernetesが表示される
        <!-- code -->
        <pre class="pre"><code># kubectl exec -it nginx -- env
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=nginx
NGINX_VERSION=1.19.6
NJS_VERSION=0.5.0
PKG_RELEASE=1~buster
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_SERVICE_PORT=443
KUBERNETES_SERVICE_PORT_HTTPS=443
TERM=xterm
HOME=/root</code></pre>
        <!-- /code/ -->
      </li>
      <li>Nginx podの削除
        <!-- code -->
        <pre class="pre"><code># kubectl delete -f nginx_configmap.yaml
pod "nginx" deleted</code></pre>
        <!-- /code/ -->
      </li>
      <li>削除されたことを確認
        <!-- code -->
        <pre class="pre"><code># kubectl get pod
No resources found in default namespace.</code></pre>
        <!-- /code/ -->
      </li>
      <li>configmapの削除
        <!-- code -->
        <pre class="pre"><code># kubectl delete configmap config
configmap "config" deleted</code></pre>
        <!-- /code/ -->
      </li>
      <li>削除されたことを確認
        <!-- code -->
        <pre class="pre"><code># kubectl get configmap
No resources found in default namespace.</code></pre>
        <!-- /code/ -->
      </li>
    </ol>

    <h5 class="h5_title">Multi-container Podの作成</h5>

    <ol>
      <li>
        <p>busyboxイメージを利用して “echo Hello, Docker & Kubernetes !!; sleep 2400”というコマンドを実行する、2つのコンテナーを内包するPodを作成します。
          2番目のコンテナーに接続して「ls」を実行してみましょう。
        </p>multi.yamlを作成
        <!-- code -->
        <pre
          class="pre"><code># kubectl run hello --image=busybox --restart=Never -o yaml --dry-run=client -- /bin/sh -c 'echo Hello, Docker & Kubernetes !!;sleep 2400' > multi.yaml</code></pre>
        <!-- /code/ -->
      </li>
      <li>2つ目のコンテナーを追記
        <!-- code -->
        <pre
          class="pre"><code># vim multi.yaml
--------------------------------------------------以下の内容をコピー&ペースト-----------------------------------------------------
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: busybox
  name: busybox
spec:
  containers:
  - args:
    - /bin/sh
    - -c
    - echo Hello, Docker & Kubernetes !!;sleep 2400
    image: busybox
    name: hello
    resources: {}
  - args:
    - /bin/sh
    - -c
    - echo Hello, Docker & Kubernetes !!;sleep 2400
    image: busybox
    name: hello2
  dnsPolicy: ClusterFirst
  restartPolicy: Never
status: {}
--------------------------------------------------[Esc + :wq]で保存終了します。--------------------------------------------------</code></pre>
        <!-- /code/ -->
      </li>
      <li>Pod作成
        <!-- code -->
        <pre class="pre"><code># kubectl create -f multi.yaml
pod/hello created</code></pre>
        <!-- /code/ -->

        <!-- code -->
        <pre class="pre"><code># kubectl get pod
NAME    READY   STATUS    RESTARTS   AGE
hello   2/2     Running   0          14s</code></pre>
        <!-- /code/ -->
      </li>
      <li>2つ目のコンテナーにアクセス
        <!-- code -->
        <pre class="pre"><code># kubectl exec -it hello -c hello2 -- /bin/sh
/ # ls
bin   dev   etc   home  proc  root  sys   tmp   usr   var
/ # exit</code></pre>
        <!-- /code/ -->
      </li>
      <li>Podの削除
        <!-- code -->
        <pre class="pre"><code># kubectl delete pod hello
pod "hello" deleted</code></pre>
        <!-- /code/ -->
      </li>
      <li>削除されたことを確認
        <!-- code -->
        <pre class="pre"><code># kubectl get pod
No resources found in default namespace.</code></pre>
        <!-- /code/ -->
      </li>
    </ol>

    <p class="text_align_center"><a href="../kouki.html">後期演習トップへ戻る</a></p>

    <p class="text_align_center"><a href="../index.html">トップへ戻る</a></p>

  </div>

  <hr>

  <footer id="footer">
    <footer-content></footer-content>
  </footer>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="../js/bootstrap.min.js"></script>
  <script src="../js/main.js"></script>
</body>

</html>